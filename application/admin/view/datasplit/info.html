<div class="page-content">
    <div class="col-sm-6 pull-right">
        <button class="btn btn-sm btn-primary pull-right" onclick="javascript:window.location.href = '/admin/Datasplit/index'">
            返回列表
            <i class="icon-reply icon-only"></i>
        </button>
    </div>

    <div class="page-header">
        <h1>
            {:model('Menu')->getParentNname()}
            <small>
                <i class="ace-icon fa fa-angle-double-right"></i>
                {:input('id')?'编辑':'新增'}
            </small>
        </h1>
    </div><!-- /.page-header -->

    <div class="row">
        <div class="col-xs-12">
            <!-- PAGE CONTENT BEGINS -->
            <form class="form-horizontal" role="form" action="{:input('id')?'/admin/Datasplit/save':'/admin/Datasplit/save'}" method="post" name="myfrom" >
                <input type="hidden" value="{$info1['ds_id']}" name="ds_id">
                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">名称</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="ds_name" value="{$info1.ds_name|default=''}"/>
                        <br /><br /> 数据库名或者表名
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">类型</label>
                    <div class="col-sm-9">
                        {:radio(model('Datasplit')->ds_table_database,$info1['ds_table_database'],'class="" name="ds_table_database"')}
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">分表/分库数量</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="ds_num" value="{$info1.ds_num|default='2'}"/>
                        <br /><br />填写：2~1000范围内的数字
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">hash分表方式</label>
                    <div class="col-sm-9">
                        {:radio(model('Datasplit')->ds_type_hash,$info1['ds_type_hash'],'class="" name="ds_type_hash"')}
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">hash分表字段</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="ds_field_hash" value="{$info1.ds_field_hash|default=''}"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">日期分表方式</label>
                    <div class="col-sm-9">
                        {:radio(model('Datasplit')->ds_type_date,$info1['ds_type_date'],'class="" name="ds_type_date"')}
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">日期分表字段</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="ds_field_date" value="{$info1.ds_field_date|default=''}"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">状态</label>
                    <div class="col-sm-9">
                        {:radio(model('Datasplit')->ds_status,$info1['ds_status'],'class="" name="ds_status"')}
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">描述</label>
                    <div class="col-sm-9">
                        <textarea id="ds_remark" name="ds_remark" cols="10" rows="5" style="width:50%; margin: 0 auto;">{$info1.ds_remark|default=''}</textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">排序</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5" name="sort_order"  value="{$info1.sort_order|default=''}" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">子表1名称</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="child_name" value="{$info1.child_name|default=''}"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">子表1自增ID</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="child_id" value="{$info1.child_id|default=''}"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">子表1关联字段</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="child_id_field" value="{$info1.child_id_field|default=''}"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">子表2名称</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="child_name2" value="{$info1.child_name2|default=''}"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">子表2自增ID</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="child_id2" value="{$info1.child_id2|default=''}"/>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label no-padding-right">子表2关联字段</label>
                    <div class="col-sm-9">
                        <input type="text" class="col-xs-10 col-sm-5"  name="child_id_field2" value="{$info1.child_id_field2|default=''}"/>
                    </div>
                </div>

                <div class="clearfix form-actions">
                    <div class="col-md-offset-3 col-md-9">
                        <button class="btn btn-info" type="button" onclick="myfrom.submit()">
                            <i class="ace-icon fa fa-check bigger-110"></i>
                            Submit
                        </button>
                        &nbsp; &nbsp; &nbsp;
                        <button class="btn" type="reset">
                            <i class="ace-icon fa fa-undo bigger-110"></i>
                            Reset
                        </button>
                    </div>
                </div>
            </form>
            <?php if(input('id')){ ?>
            <label class="col-sm-3 control-label no-padding-right">已经成功分表次数：{$info1['ds_editnum']}</label>
            <span class="btn btn-sm btn-primary pull-right" onclick="adminShow(0);">
                执行分表/分库
                <i class="icon-reply icon-only"></i>
            </span>
            <?php } ?>
            <table id="simple-table" class="table  table-bordered table-hover">
                <thead>
                <tr>
                    <th class="detail-col">序号ID</th>
                    <th>名称</th>
                    <th>创建时间</th>
                    <th>更新时间</th>
                    <th>日期开始</th>
                    <th>日期结束</th>
                    <th>子表1</th>
                    <th>子表2</th>
                    <th>执行次数</th>
                </tr>
                </thead>

                <tbody>

                <form action="" method="post" name="myform">

                    {volist name="lists" id="vo"}
                    <tr>
                        <td>{$vo.ds_d_id}</td>
                        <td>{$vo['name']}</td>
                        <td>{:date('Y-m-d',$vo['create_time'])}</td>
                        <td>{:date('Y-m-d',$vo['update_time'])}</td>
                        <td>{:date('Y-m-d',$vo['begin_time'])}</td>
                        <td>{:date('Y-m-d',$vo['end_time'])}</td>
                        <td>{$vo['child_name']}</td>
                        <td>{$vo['child_name2']}</td>
                        <td>{$vo['ds_status']}</td>
                    </tr>
                    {/volist}
                </form>
                </tbody>
            </table>
            <!-- PAGE CONTENT ENDS -->
        </div><!-- /.col -->
    </div><!-- /.row -->
</div><!-- /.page-content -->
<!-- 配置文件 -->

<script>
    var fileUrl = '/admin/Datasplit/create';
    function adminShow(p){
        //$.loading();
        $.ajax({
            type: "GET",
            url: fileUrl,
            data: {id:{$info1['ds_id']}, page:p},
            dataType: "json",
            success: function(datas){
                if(datas.code == 0) {
                    if (datas.data == 1) {
                        console.log(datas.msg +"....");
                        childShow(0);
                    }else{
                        console.log(datas.msg +"....");
                        //table.reload('table-list');
                        adminShow(p + 1);
                    }
                }else{
                    console.log(datas.msg + "....");
                }
            }

        });
    }
    function childShow(p){
        //$.loading();
        $.ajax({
            type: "GET",
            url: fileUrl,
            data: {id:{$info1['ds_id']}, page:p, do_child:1},
            dataType: "json",
            success: function(datas){
                if(datas.code == 0) {
                    if (datas.data == 1) {
                        console.log(datas.msg + "....");
                        location.reload();
                    } else {
                        console.log(datas.msg + "....");
                        //table.reload('table-list');
                        childShow(p + 1);
                    }
                }else{
                    console.log(datas.msg + "....");
                }
            }

        });
    }
</script>